name: lfs-lock

on:
    workflow_dispatch:

jobs:
    matrix-job:
        name: runs
        runs-on: ubuntu-latest
        strategy:
          matrix: 
            version: [1, 2, 3]
        steps:
          - uses: actions/checkout@v4
          - run: |
                wait=false
                git lfs install
                git lfs lock lockfile.lock || wait=true

                while $wait; do
                    echo "Waiting for lock to be released"
                    sleep 1
                    wait=false
                    git lfs lock lockfile.lock || wait=true
                done

                echo start ${{ matrix.version }}
                if [[ -f somefile.txt ]]; then
                    cat somefile.txt
                else
                    echo "somefile.txt not found"
                fi
                
                
                git config --global user.name 'mtintes'
                git config --global user.email 'mike.tintes@hotmail.com'
                echo "Write ${{ matrix.version }} - $RANDOM" > somefile.txt
                # echo "diff-index"
                # git diff-index --quiet HEAD
                echo "add"
                git add somefile.txt 
                echo "commit"
                git commit -am "Write ${{ matrix.version }}" -m "Wrote ${{ matrix.version }}"
                echo "fetch"
                git fetch origin main
                echo "rebase"
                git rebase origin/main
                git push

                echo finish ${{ matrix.version }}
                cat somefile.txt
                git lfs unlock lockfile.lock